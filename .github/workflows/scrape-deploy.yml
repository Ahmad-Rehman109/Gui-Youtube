name: Scrape and Deploy

on:
  schedule:
    # Every 30 minutes from 9 AM to 1 AM PKT (16 hours)
    # PKT is UTC+5, so 9 AM PKT = 4 AM UTC, 1 AM PKT = 8 PM UTC (previous day)
    - cron: '*/30 4-23 * * *'  # 4 AM to 11:30 PM UTC
    - cron: '0,30 0 * * *'      # 12:00 AM and 12:30 AM UTC
    
    # Every 60 minutes from 1 AM to 9 AM PKT (8 hours)
    - cron: '0 1-3 * * *'       # 1 AM to 3 AM UTC
  
  workflow_dispatch: # Allow manual trigger

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      deployments: write
    
    steps:
    # Step 1: Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v3
      
    # Step 2: Set up Python for scraping
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    # Step 3: Install Python dependencies
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests aiohttp
        
    # Step 4: Run scraper
    - name: Run YouTube scraper
      run: python scraper.py
      
    # Step 5: Commit and push updated data
    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add youtube_stats.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "üìä Update YouTube stats - $(date)" && git push)
      
    # Step 6: Set up Node.js for building
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
          
    # Step 7: Install Node dependencies
    - name: Install Node dependencies
      run: npm ci
        
    # Step 8: Build React app
    - name: Build React app
      run: npm run build
        
    # Step 9: Deploy to Cloudflare Pages
    - name: Deploy to Cloudflare Pages
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: youtube-stats-dashboard
        directory: dist
        gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          
    # Step 10: Success summary
    - name: Deployment Summary
      run: |
        echo "‚úÖ Scraping completed"
        echo "‚úÖ Data committed to repository"
        echo "‚úÖ Deployed to Cloudflare Pages"
        echo "üïê Completed at: $(date)"
